(ns shibeshibe.db.writes
  (:require [shibeshibe.tasks.crawl-markets :as mm]
            [shibeshibe.datomic.core :as db]
            [shibeshibe.components :as com]
            [shibeshibe.db.reads :as reads]
            [shibeshibe.utils :refer :all]
            [midje.sweet :refer :all]))

(defn read-sources! [context]
  (let [db (-> (get context ::com/system) :db deref)]
   (doseq [item (mm/get-market-data)]
     (let [object (.entity item)
           eid (-> object (select-keys [:market/broker :market/with :market/buy]) (->> (db/entity->eid (:db db))))]
       (-> object (assoc-maybe :db/id eid) db/transact-one)))))
